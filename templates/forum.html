<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>ShapeShift - Forum</title>
		<link
			rel="stylesheet"
			href="{{ url_for('static', filename='styleForum.css') }}" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Oswald:wght@700&display=swap"
			rel="stylesheet" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
		<script
			type="module"
			src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
		<script
			nomodule
			src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
		<script src="{{ url_for('static', filename='surveydatabase/logic.js') }}"></script>
	</head>

	<body>
		<nav class="navbar" style="position: relative; margin-bottom: 0">
			<div class="logo">
				<img
					src="{{ url_for('static', filename='images/logo prze≈∫.png') }}"
					alt="logo"
					class="logo-img" />
				<span>ShapeShift</span>
			</div>
			<ul class="nav-links">
				<li><a href="{{ url_for('main') }}">Home</a></li>
				<li><a href="{{ url_for('survey') }}">Survey</a></li>
				<li><a href="{{ url_for('forum') }}">Forum</a></li>
				<li><a href="{{ url_for('results') }}">Plan</a></li>
			</ul>
			<div class="icons">
				{% if user %}
				<div class="user-info">
					<span class="username-display"
						><i class="fas fa-user-circle"></i> {{ user }}</span
					>
					<a href="{{ url_for('logout') }}" class="logout-btn">
						<i class="fas fa-sign-out-alt"></i> Logout
					</a>
				</div>
				{% else %}
				<span class="icon"
					><ion-icon name="person-circle-outline"></ion-icon
				></span>
				<a href="{{ url_for('login') }}">Log in</a>
				{% endif %}
			</div>
		</nav>

		<div class="flash-container">
			{% with messages = get_flashed_messages(with_categories=true) %} {% if
			messages %} {% for category, message in messages %}
			<div class="flash-message {{ category }}">{{ message }}</div>
			{% endfor %} {% endif %} {% endwith %}
		</div>

		<div class="container forum-container">
			<div class="forum-header">
				<h1>Community Forum</h1>
				<p>Share your progress, ask questions, and motivate others!</p>
			</div>

			{% if user %}
			<div class="create-post-card">
				<h3>Create a Post</h3>
				<form action="{{ url_for('add_post') }}" method="POST">
					<textarea
						name="content"
						rows="3"
						placeholder="What's on your mind regarding fitness?"
						required></textarea>
					<button type="submit" class="btn-primary">Post</button>
				</form>
			</div>
			{% else %}
			<div class="login-prompt">
				<p>
					<a href="{{ url_for('login') }}">Log in</a> to create posts and
					comment.
				</p>
			</div>
			{% endif %}

			<div class="posts-feed">
				{% for post in posts %}
				<article class="post-card">
					<div class="post-header">
						<div class="header-left">
							<div class="author-avatar">
								<ion-icon name="barbell-outline"></ion-icon>
							</div>
							<div class="post-meta">
								<span class="author-name">{{ post.username }}</span>
								<span class="post-date">{{ post.created_at }}</span>
							</div>
						</div>

						{% if session.get('user_id') == post.user_id %}
						<div class="header-right">
							<form
								action="{{ url_for('delete_post', post_id=post.id) }}"
								method="POST"
								onsubmit="openDeleteModal(event, this)">
								<button type="submit" class="delete-btn" title="Delete Post">
									<ion-icon name="trash-outline"></ion-icon>
								</button>
							</form>
						</div>
						{% endif %}
					</div>

					<div class="post-content">{{ post.content }}</div>

					<div class="post-actions">
						<div class="reactions-group">
							<span
								class="reaction-btn {% if post.user_reaction == 'like' %}active{% endif %}"
								onclick="handleReaction({{ post.id }}, 'like')"
								title="Like">
								üëç
								<span class="count" id="count-like-{{ post.id }}"
									>{{ post.reactions.like|default(0) }}</span
								>
							</span>

							<span
								class="reaction-btn {% if post.user_reaction == 'heart' %}active{% endif %}"
								onclick="handleReaction({{ post.id }}, 'heart')"
								title="Love">
								‚ù§Ô∏è
								<span class="count" id="count-heart-{{ post.id }}"
									>{{ post.reactions.heart|default(0) }}</span
								>
							</span>

							<span
								class="reaction-btn {% if post.user_reaction == 'muscle' %}active{% endif %}"
								onclick="handleReaction({{ post.id }}, 'muscle')"
								title="Strong">
								üí™
								<span class="count" id="count-muscle-{{ post.id }}"
									>{{ post.reactions.muscle|default(0) }}</span
								>
							</span>

							<span
								class="reaction-btn {% if post.user_reaction == 'fire' %}active{% endif %}"
								onclick="handleReaction({{ post.id }}, 'fire')"
								title="Fire">
								üî•
								<span class="count" id="count-fire-{{ post.id }}"
									>{{ post.reactions.fire|default(0) }}</span
								>
							</span>
						</div>
					</div>

					<div class="comments-section">
						{% if post.comments %}
						<div class="comments-list">
							{% for comment in post.comments %}
							<div class="comment">
								<div class="comment-content-wrapper">
									<span class="comment-author">{{ comment.username }}:</span>
									<span class="comment-text">{{ comment.content }}</span>
								</div>

								<div class="comment-meta-wrapper">
									<span class="comment-date">{{ comment.created_at }}</span>

									{% if session.get('user_id') == comment.user_id %}
									<form
										action="{{ url_for('delete_comment', comment_id=comment.id) }}"
										method="POST"
										style="display: inline"
										onsubmit="openDeleteModal(event, this)">
										<button
											type="submit"
											class="delete-btn-small"
											title="Delete Comment">
											<i class="fas fa-times"></i>
										</button>
									</form>
									{% endif %}
								</div>
							</div>
							{% endfor %}
						</div>
						{% endif %} {% if user %}
						<form
							action="{{ url_for('add_comment', post_id=post.id) }}"
							method="POST"
							class="comment-form">
							<input
								type="text"
								name="content"
								placeholder="Write a comment..."
								required
								autocomplete="off" />
							<button type="submit"><ion-icon name="send"></ion-icon></button>
						</form>
						{% endif %}
					</div>
				</article>
				{% else %}
				<p style="text-align: center; color: var(--color-text-secondary)">
					No posts yet. Be the first one!
				</p>
				{% endfor %}
			</div>
		</div>

		<div id="deleteModal" class="modal-overlay">
			<div class="modal-content">
				<h3>Are you sure?</h3>
				<p>This action cannot be undone. Do you really want to delete this?</p>
				<div class="modal-actions">
					<button class="btn-cancel" onclick="closeModal()">Cancel</button>
					<button class="btn-confirm-delete" onclick="confirmDelete()">
						Yes, Delete
					</button>
				</div>
			</div>
		</div>

		<script>
			let formToSubmit = null; // Zmienna do przechowania formularza

			function openDeleteModal(event, form) {
				event.preventDefault(); // Zatrzymaj natychmiastowe wysy≈Çanie
				formToSubmit = form; // Zapamiƒôtaj, kt√≥ry formularz chcieli≈õmy wys≈Çaƒá
				document.getElementById("deleteModal").classList.add("active"); // Poka≈º okno
			}

			function closeModal() {
				document.getElementById("deleteModal").classList.remove("active"); // Ukryj okno
				formToSubmit = null;
			}

			function confirmDelete() {
				if (formToSubmit) {
					formToSubmit.submit(); // Wy≈õlij zapamiƒôtany formularz
				}
			}

			// Zamknij modal, je≈õli klikniƒôto w t≈Ço (poza okienkiem)
			document
				.getElementById("deleteModal")
				.addEventListener("click", function (e) {
					if (e.target === this) {
						closeModal();
					}
				});
		</script>

		<!-- Bottom section -->
		<footer class="site-footer">
			<div class="container">
				<div class="footer-grid">
					<div class="footer-column">
						<h3>ShapeShift</h3>
						<p>
							Your path to better fitness. Personalized workout plans that work.
						</p>
					</div>
					<div class="footer-column">
						<h3>Fast travel</h3>
						<ul class="footer-links">
							<li><a href="{{ url_for('main') }}">Home</a></li>
							<li><a href="{{ url_for('survey') }}">Survey</a></li>
							<li><a href="{{ url_for('forum') }}">Forum</a></li>
							<li><a href="{{ url_for('results') }}">Plan</a></li>
						</ul>
					</div>
					<div class="footer-column">
						<h3>Our socials</h3>
						<p>Follow our social media to stay up to date:</p>
						<div class="social-icons">
							<a href="#"><i class="fab fa-facebook-f"></i></a>
							<a href="#"><i class="fab fa-instagram"></i></a>
							<a href="#"><i class="fab fa-twitter"></i></a>
							<a href="#"><i class="fab fa-youtube"></i></a>
						</div>
					</div>
				</div>
				<div class="footer-bottom">
					<p>&copy; 2025 ShapeShift. All rights reserved.</p>
				</div>
			</div>
		</footer>
	</body>
</html>
